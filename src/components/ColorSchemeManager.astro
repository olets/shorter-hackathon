---
const allowedColorSchemes = ["light dark", "dark", "light"]
const defaultColorScheme = "light dark"
---

<script define:vars={{ defaultColorScheme, allowedColorSchemes }}>
  window.colorScheme ??= (() => {
    const storageKey = "colorScheme";

    const store =
      typeof localStorage !== "undefined"
        ? localStorage
        : { getItem: () => null, setItem: () => {} };

    function set(requestedColorScheme = defaultColorScheme) {
      let colorScheme = requestedColorScheme;
      
      if (!allowedColorSchemes.includes(requestedColorScheme)) {
        colorScheme = defaultColorScheme;
      }

      store.setItem(storageKey, colorScheme);
    }

    function get() {
      return store.getItem(storageKey) || defaultColorScheme;
    }

    return { set, get };
  })();
  colorScheme.set(colorScheme.get());
</script>

<script>
  document.addEventListener("astro:after-swap", () =>
    // SEEALSO src/components/ColorSchemeManager.astro, src/env.d.ts
    window.colorScheme.set(window.colorScheme.get()),
  );
</script>
